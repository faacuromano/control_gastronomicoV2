generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// FIX P1-001 PHASE 3: Multi-Tenancy
// Every record belongs to a Tenant
model Tenant {
  id                    Int                    @id @default(autoincrement())
  name                  String
  code                  String                 @unique // "default", "franchise_1"
  activeSubscription    Boolean                @default(true)
  configs               TenantConfig[]
  users                 User[]
  roles                 Role[]
  categories            Category[]
  products              Product[]
  tables                Table[]
  areas                 Area[]
  clients               Client[]
  orders                Order[]
  shifts                CashShift[]
  sequences             OrderSequence[]
  printers              Printer[]
  platformConfigs       TenantPlatformConfig[]
  invoices              Invoice[]
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  modifierGroups        ModifierGroup[]
  ingredients           Ingredient[]
  suppliers             Supplier[]
  purchaseOrders        PurchaseOrder[]
  paymentMethodConfigs  PaymentMethodConfig[]
  deliveryDrivers       DeliveryDriver[]
  auditLogs             AuditLog[]
  qrCodes               QrCode[]
  // New multi-tenant relations
  stockMovements        StockMovement[]
  payments              Payment[]
  orderItems            OrderItem[]
  orderItemModifiers    OrderItemModifier[]
  purchaseOrderItems    PurchaseOrderItem[]
  modifierOptions       ModifierOption[]
  productIngredients    ProductIngredient[]
  productModifierGroups ProductModifierGroup[]
  areaPrinterOverrides  AreaPrinterOverride[]
  productChannelPrices  ProductChannelPrice[]
  taxRates              TaxRate[]
  refreshTokens         RefreshToken[]
}

model TenantConfig {
  id                 Int        @id @default(autoincrement())
  tenantId           Int
  tenant             Tenant     @relation(fields: [tenantId], references: [id])
  businessName       String
  enableStock        Boolean    @default(true)
  enableDelivery     Boolean    @default(true)
  enableKDS          Boolean    @default(false)
  enableFiscal       Boolean    @default(false)
  enableDigital      Boolean    @default(false)
  enableBlindCount   Boolean    @default(false)
  currencySymbol     String     @default("$")
  defaultTaxRate     Decimal    @default(0) @db.Decimal(5, 2) // Default tax rate percentage (e.g. 21.00 for 21%)
  // QR Menu Configuration
  qrMenuEnabled      Boolean    @default(false)
  qrMenuMode         QrMenuMode @default(INTERACTIVE)
  qrSelfOrderEnabled Boolean    @default(false)
  qrMenuPdfUrl       String?
  qrMenuBannerUrl    String?
  qrMenuTheme        Json?

  @@index([tenantId])
}

// FIX P1-001 PHASE 2: Hourly-based sharding to eliminate lock contention
// Each hour gets its own sequence row, reducing contention by 24x
// FORMAT: "YYYYMMDDHH" (e.g., "2026011914" for Jan 19, 2PM)
// PERFORMANCE: Latency expected to drop from 1200ms to ~50ms
model OrderSequence {
  id           Int      @id @default(autoincrement())
  tenantId     Int
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  sequenceKey  String   @db.VarChar(50) // "TENANT_1_DATE_20260119"
  currentValue Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([tenantId, sequenceKey]) // Tenant scoped sequence
  @@index([tenantId])
}

model Role {
  id          Int    @id @default(autoincrement())
  tenantId    Int
  tenant      Tenant @relation(fields: [tenantId], references: [id])
  name        String // Not unique globally anymore
  permissions Json
  users       User[]

  @@unique([tenantId, name]) // Unique per tenant
  @@index([tenantId])
}

model User {
  id                  Int         @id @default(autoincrement())
  tenantId            Int
  tenant              Tenant      @relation(fields: [tenantId], references: [id])
  roleId              Int
  role                Role        @relation(fields: [roleId], references: [id])
  name                String
  email               String? // Not unique globally anymore, or should it? Usually email IS global, but let's scope it for now
  pinHash             String?     @db.VarChar(60)
  // pinLookup deferred — add back when DB migration is applied
  // pinLookup           String?     @db.VarChar(16)
  passwordHash        String?
  uiSettings          Json?
  orders              Order[]     @relation("OrderServer")
  deliveries          Order[]     @relation("OrderDriver")
  shifts              CashShift[]
  refreshTokens       RefreshToken[]
  isActive            Boolean     @default(true)
  failedLoginAttempts Int         @default(0)
  lockedUntil         DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([roleId])
}

model RefreshToken {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token       String   @unique @db.VarChar(64) // SHA-256 hash of the token
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([expiresAt]) // For cleanup queries
}

model Category {
  id               Int                   @id @default(autoincrement())
  tenantId         Int
  tenant           Tenant                @relation(fields: [tenantId], references: [id])
  name             String
  printerId        Int?
  printer          Printer?              @relation(fields: [printerId], references: [id])
  products         Product[]
  printerOverrides AreaPrinterOverride[]
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([printerId])
}

model Printer {
  id             Int                   @id @default(autoincrement())
  tenantId       Int
  tenant         Tenant                @relation(fields: [tenantId], references: [id])
  name           String
  connectionType PrinterConnection     @default(NETWORK)
  ipAddress      String?
  windowsName    String?
  categories     Category[]
  areaOverrides  AreaPrinterOverride[]
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

enum PrinterConnection {
  NETWORK // TCP/IP connection (tcp://IP:9100)
  USB // Windows USB printer via printer name
}

model Product {
  id            Int                    @id @default(autoincrement())
  tenantId      Int
  tenant        Tenant                 @relation(fields: [tenantId], references: [id])
  categoryId    Int
  category      Category               @relation(fields: [categoryId], references: [id])
  name          String
  description   String?
  price         Decimal                @db.Decimal(10, 2)
  image         String?
  productType   ProductType            @default(SIMPLE)
  isStockable   Boolean                @default(true)
  ingredients   ProductIngredient[]
  modifiers     ProductModifierGroup[]
  isActive      Boolean                @default(true)
  orderItems    OrderItem[]
  channelPrices ProductChannelPrice[]
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId, isActive, categoryId])
  @@index([tenantId])
  @@index([categoryId])
}

enum ProductType {
  SIMPLE
  COMBO
  RECIPE
}

model ModifierGroup {
  id           Int                    @id @default(autoincrement())
  tenantId     Int
  tenant       Tenant                 @relation(fields: [tenantId], references: [id])
  name         String
  minSelection Int                    @default(0)
  maxSelection Int                    @default(1)
  options      ModifierOption[]
  products     ProductModifierGroup[]
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

model ProductModifierGroup {
  tenantId        Int
  tenant          Tenant        @relation(fields: [tenantId], references: [id])
  productId       Int
  modifierGroupId Int
  product         Product       @relation(fields: [productId], references: [id])
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id])

  @@id([productId, modifierGroupId])
  @@index([tenantId])
  @@index([modifierGroupId])
  @@index([productId])
}

model ModifierOption {
  id              Int                 @id @default(autoincrement())
  tenantId        Int
  tenant          Tenant              @relation(fields: [tenantId], references: [id])
  modifierGroupId Int
  group           ModifierGroup       @relation(fields: [modifierGroupId], references: [id])
  name            String
  priceOverlay    Decimal             @default(0) @db.Decimal(10, 2)
  isActive        Boolean             @default(true)
  ingredientId    Int?
  ingredient      Ingredient?         @relation(fields: [ingredientId], references: [id])
  qtyUsed         Decimal?            @default(1)
  orderModifiers  OrderItemModifier[]

  @@index([tenantId])
  @@index([modifierGroupId])
  @@index([ingredientId])
}

model Ingredient {
  id                 Int                 @id @default(autoincrement())
  tenantId           Int
  tenant             Tenant              @relation(fields: [tenantId], references: [id])
  name               String
  unit               String
  cost               Decimal             @db.Decimal(10, 4)
  stock              Decimal             @db.Decimal(10, 4)
  minStock           Decimal             @default(0) @db.Decimal(10, 4)
  products           ProductIngredient[]
  modifiers          ModifierOption[]
  movements          StockMovement[]
  purchaseOrderItems PurchaseOrderItem[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

model ProductIngredient {
  tenantId     Int
  tenant       Tenant     @relation(fields: [tenantId], references: [id])
  productId    Int
  ingredientId Int
  quantity     Decimal    @db.Decimal(10, 4)
  product      Product    @relation(fields: [productId], references: [id])
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  @@id([productId, ingredientId])
  @@index([tenantId])
  @@index([ingredientId])
  @@index([productId])
}

model StockMovement {
  id           Int           @id @default(autoincrement())
  tenantId     Int
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  ingredientId Int
  ingredient   Ingredient    @relation(fields: [ingredientId], references: [id])
  type         StockMoveType
  quantity     Decimal       @db.Decimal(10, 4)
  reason       String? // Reason for movement (e.g. "Order #123", "Expired")
  createdAt    DateTime      @default(now())

  @@index([tenantId])
  @@index([ingredientId])
  // Composite indexes for history queries
  @@index([tenantId, createdAt])
  @@index([ingredientId, createdAt])
}

enum StockMoveType {
  PURCHASE
  SALE
  WASTE
  ADJUSTMENT
}

model Supplier {
  id             Int             @id @default(autoincrement())
  tenantId       Int
  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  name           String
  phone          String?
  email          String?
  address        String?
  taxId          String? // CUIT/RUT
  purchaseOrders PurchaseOrder[]
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([name])
  @@index([tenantId])
}

enum PurchaseStatus {
  PENDING
  ORDERED
  PARTIAL
  RECEIVED
  CANCELLED
}

model PurchaseOrder {
  id          Int                 @id @default(autoincrement())
  tenantId    Int
  tenant      Tenant              @relation(fields: [tenantId], references: [id])
  orderNumber Int
  supplierId  Int
  supplier    Supplier            @relation(fields: [supplierId], references: [id])
  status      PurchaseStatus      @default(PENDING)
  subtotal    Decimal             @default(0) @db.Decimal(10, 2)
  total       Decimal             @default(0) @db.Decimal(10, 2)
  notes       String?             @db.Text
  orderedAt   DateTime            @default(now())
  receivedAt  DateTime?
  items       PurchaseOrderItem[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@unique([tenantId, orderNumber])
  @@index([supplierId])
  @@index([status])
  @@index([orderedAt])
  @@index([tenantId])
}

model PurchaseOrderItem {
  id              Int           @id @default(autoincrement())
  tenantId        Int
  tenant          Tenant        @relation(fields: [tenantId], references: [id])
  purchaseOrderId Int
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  ingredientId    Int
  ingredient      Ingredient    @relation(fields: [ingredientId], references: [id])
  quantity        Decimal       @db.Decimal(10, 4)
  unitCost        Decimal       @db.Decimal(10, 4)

  @@index([tenantId])
  @@index([purchaseOrderId])
  @@index([ingredientId])
}

// ==================== INVOICING ====================

model Invoice {
  id            Int         @id @default(autoincrement())
  tenantId      Int
  tenant        Tenant      @relation(fields: [tenantId], references: [id])
  orderId       Int         @unique
  order         Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  invoiceNumber String // Unique per Tenant
  type          InvoiceType @default(RECEIPT)
  clientName    String?
  clientTaxId   String?
  subtotal      Decimal     @db.Decimal(10, 2)
  tax           Decimal     @default(0) @db.Decimal(10, 2)
  total         Decimal     @db.Decimal(10, 2)
  createdAt     DateTime    @default(now())

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
}

enum InvoiceType {
  RECEIPT // Ticket simple
  INVOICE_B // Factura B (Consumidor Final)
}

model TaxRate {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String   // e.g. "IVA 21%", "IVA 10.5%", "Exento"
  rate        Decimal  @db.Decimal(5, 2) // Percentage (e.g. 21.00)
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Order {
  id                  Int               @id @default(autoincrement())
  tenantId            Int
  tenant              Tenant            @relation(fields: [tenantId], references: [id])
  orderNumber         Int
  channel             OrderChannel      @default(POS)
  externalId          String?
  externalPayload     Json?
  peopleCount         Int               @default(1)
  status              OrderStatus       @default(OPEN)
  paymentStatus       PaymentStatus     @default(PENDING)
  subtotal            Decimal           @default(0) @db.Decimal(10, 2)
  discount            Decimal           @default(0) @db.Decimal(10, 2)
  tip                 Decimal           @default(0) @db.Decimal(10, 2)
  total               Decimal           @default(0) @db.Decimal(10, 2)
  tableId             Int?
  table               Table?            @relation(fields: [tableId], references: [id])
  clientId            Int?
  client              Client?           @relation(fields: [clientId], references: [id])
  serverId            Int?
  server              User?             @relation("OrderServer", fields: [serverId], references: [id])
  driverId            Int?
  driver              User?             @relation("OrderDriver", fields: [driverId], references: [id])
  deliveryAddress     String?
  deliveryNotes       String?
  // Delivery Integration fields
  fulfillmentType     FulfillmentType   @default(DINE_IN)
  deliveryPlatformId  Int?
  deliveryPlatform    DeliveryPlatform? @relation("PlatformOrders", fields: [deliveryPlatformId], references: [id])
  deliveryDriverId    Int?
  deliveryDriver      DeliveryDriver?   @relation("DeliveryDriverOrders", fields: [deliveryDriverId], references: [id])
  estimatedDeliveryAt DateTime?
  deliveryFee         Decimal?          @db.Decimal(10, 2)
  platformCommission  Decimal?          @db.Decimal(10, 2)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  closedAt            DateTime?
  businessDate        DateTime          @db.Date
  items               OrderItem[]
  payments            Payment[]
  invoice             Invoice?

  @@unique([tenantId, businessDate, orderNumber]) // Unique per Tenant per Day
  @@index([tenantId])
  @@index([tableId])
  @@index([clientId])
  @@index([serverId])
  @@index([driverId])
  @@index([deliveryPlatformId])
  @@index([deliveryDriverId])
  @@index([createdAt])
  @@index([externalId])
  // Composite indexes for common query patterns
  @@index([tenantId, status])
  @@index([tenantId, businessDate, status])
  @@index([tenantId, paymentStatus])
  @@index([tenantId, channel])
}

enum OrderChannel {
  POS
  WAITER_APP
  QR_MENU
  DELIVERY_APP
}

enum OrderStatus {
  OPEN
  CONFIRMED
  IN_PREPARATION
  PREPARED
  ON_ROUTE
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

model OrderItem {
  id        Int                 @id @default(autoincrement())
  tenantId  Int
  tenant    Tenant              @relation(fields: [tenantId], references: [id])
  orderId   Int
  order     Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId Int
  product   Product             @relation(fields: [productId], references: [id])
  quantity  Int
  unitPrice Decimal             @db.Decimal(10, 2)
  modifiers OrderItemModifier[]
  status    ItemStatus          @default(PENDING)
  notes     String?

  @@index([tenantId])
  @@index([orderId])
  @@index([orderId, productId])
  @@index([orderId, status])
  @@index([productId])
}

enum ItemStatus {
  PENDING
  COOKING
  READY
  SERVED
}

model OrderItemModifier {
  id               Int            @id @default(autoincrement())
  tenantId         Int
  tenant           Tenant         @relation(fields: [tenantId], references: [id])
  orderItemId      Int
  orderItem        OrderItem      @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifierOptionId Int
  modifierOption   ModifierOption @relation(fields: [modifierOptionId], references: [id])
  priceCharged     Decimal        @db.Decimal(10, 2)

  @@index([tenantId])
  @@index([orderItemId])
  @@index([modifierOptionId])
}

model Area {
  id               Int                   @id @default(autoincrement())
  tenantId         Int
  tenant           Tenant                @relation(fields: [tenantId], references: [id])
  name             String
  tables           Table[]
  printerOverrides AreaPrinterOverride[]
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

// Print Routing Override per Area (Toast-style)
// Allows an area to override the default category->printer routing
// Example: "Terraza" area sends all drinks to "Printer Terraza" instead of "Bar Printer"
model AreaPrinterOverride {
  id         Int       @id @default(autoincrement())
  tenantId   Int
  tenant     Tenant    @relation(fields: [tenantId], references: [id])
  areaId     Int
  area       Area      @relation(fields: [areaId], references: [id], onDelete: Cascade)
  categoryId Int? // If null, applies to ALL categories (area-wide override)
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  printerId  Int
  printer    Printer   @relation(fields: [printerId], references: [id])
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([areaId, categoryId]) // One override per category per area
  @@index([tenantId])
  @@index([areaId])
  @@index([categoryId])
  @@index([printerId])
}

model Table {
  id             Int         @id @default(autoincrement())
  tenantId       Int
  tenant         Tenant      @relation(fields: [tenantId], references: [id])
  areaId         Int
  area           Area        @relation(fields: [areaId], references: [id])
  name           String
  x              Int?
  y              Int?
  status         TableStatus @default(FREE)
  currentOrderId Int?
  orders         Order[]
  qrCodes        QrCode[]
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([areaId])
}

enum TableStatus {
  FREE
  OCCUPIED
  RESERVED
  CLEANING
}

model Client {
  id            Int      @id @default(autoincrement())
  tenantId      Int
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  name          String
  phone         String?
  email         String?
  address       String?
  taxId         String?
  points        Int      @default(0)
  walletBalance Decimal  @default(0) @db.Decimal(10, 2)
  orders        Order[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([tenantId, phone]) // Unique per tenant
  @@unique([tenantId, email])
  @@index([tenantId])
}

model CashShift {
  id           Int       @id @default(autoincrement())
  tenantId     Int
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  userId       Int
  user         User      @relation(fields: [userId], references: [id])
  startTime    DateTime  @default(now())
  endTime      DateTime?
  startAmount  Decimal   @db.Decimal(10, 2)
  endAmount    Decimal?  @db.Decimal(10, 2)
  businessDate DateTime  @db.Date
  payments     Payment[]

  @@index([tenantId])
  @@index([userId])
  @@index([businessDate])
  // Composite index for open shift lookups
  @@index([tenantId, userId, endTime])
}

model Payment {
  id          Int           @id @default(autoincrement())
  tenantId    Int
  tenant      Tenant        @relation(fields: [tenantId], references: [id])
  orderId     Int
  order       Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  shiftId     Int?
  shift       CashShift?    @relation(fields: [shiftId], references: [id])
  amount      Decimal       @db.Decimal(10, 2)
  tip         Decimal       @default(0) @db.Decimal(10, 2) // Tip included in this payment
  method      PaymentMethod
  externalRef String?
  createdAt   DateTime      @default(now())

  @@index([tenantId])
  @@index([orderId])
  @@index([shiftId])
  // Composite indexes for shift reports and payment analytics
  @@index([shiftId, method])
  @@index([tenantId, method])
  @@index([tenantId, createdAt])
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  QR_INTEGRATED
  ONLINE
}

// Dynamic payment method configuration
model PaymentMethodConfig {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  code      String // Matches PaymentMethod enum value
  name      String // Display name: "Efectivo", "Tarjeta", etc.
  icon      String? // Lucide icon name
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
}

// Audit log for tracking critical actions
model AuditLog {
  id        Int         @id @default(autoincrement())
  tenantId  Int
  tenant    Tenant      @relation(fields: [tenantId], references: [id])
  userId    Int?
  action    AuditAction
  entity    String // Table/model name: 'Order', 'Payment', 'CashShift'
  entityId  Int?
  details   Json? // Additional context (old/new values, etc)
  ipAddress String?
  userAgent String?
  createdAt DateTime    @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([action])
  @@index([createdAt])
  @@index([tenantId])
  // Composite indexes for tenant audit reports
  @@index([tenantId, createdAt])
  @@index([tenantId, entity, entityId])
}

enum AuditAction {
  // Auth
  LOGIN
  LOGOUT
  LOGIN_FAILED
  // Orders
  ORDER_CREATED
  ORDER_CANCELLED
  ORDER_REFUNDED
  // Order Items
  ITEM_VOIDED // Item removed from order with reason
  ITEM_TRANSFERRED // Item moved to different table
  // Payments
  PAYMENT_RECEIVED
  PAYMENT_VOIDED
  // Pricing
  DISCOUNT_APPLIED // Manual discount with authorization
  // Cash
  SHIFT_OPENED
  SHIFT_CLOSED
  CASH_ADJUSTMENT
  // Inventory
  STOCK_ADJUSTED
  STOCK_WASTED
  BULK_PRICE_UPDATE // Mass price update operation
  // Admin
  USER_CREATED
  USER_DELETED
  ROLE_CHANGED
  CONFIG_CHANGED
  // Sync
  SYNC_COMPLETED
}

// ============================================================================
// QR MENU
// ============================================================================

enum QrMenuMode {
  INTERACTIVE // Menú dinámico desde DB
  STATIC // PDF o imagen subida
}

model QrCode {
  id            Int       @id @default(autoincrement())
  tenantId      Int
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  code          String    @unique @db.VarChar(12) // UUID corto para URL
  tableId       Int? // null = QR genérico (no asociado a mesa)
  table         Table?    @relation(fields: [tableId], references: [id])
  isActive      Boolean   @default(true)
  scansCount    Int       @default(0)
  lastScannedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tableId])
  @@index([tenantId])
}

// ============================================================================
// DELIVERY INTEGRATION
// ============================================================================

enum FulfillmentType {
  DINE_IN // Mesa en local
  TAKEAWAY // Para llevar (retira cliente)
  PLATFORM_DELIVERY // Delivery por plataforma externa (Rappi envía)
  SELF_DELIVERY // Delivery con flota propia del local
}

// 1. GLOBAL PLATFORM CATALOG (e.g. "Rappi", "PedidosYa")
model DeliveryPlatform {
  id            Int                    @id @default(autoincrement())
  code          String                 @unique // PEDIDOSYA, RAPPI, GLOVO
  name          String
  isEnabled     Boolean                @default(false)
  // LEGACY FIELDS - Kept for migration, will be removed later
  apiKey        String?                @db.VarChar(500)
  webhookSecret String?                @db.VarChar(500)
  storeId       String?
  // End Legacy
  tenantConfigs TenantPlatformConfig[]
  orders        Order[]                @relation("PlatformOrders")
  productPrices ProductChannelPrice[]
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
}

// 2. TENANT-SPECIFIC CONFIGURATION
model TenantPlatformConfig {
  id                 Int              @id @default(autoincrement())
  tenantId           Int
  tenant             Tenant           @relation(fields: [tenantId], references: [id])
  deliveryPlatformId Int
  deliveryPlatform   DeliveryPlatform @relation(fields: [deliveryPlatformId], references: [id])

  // Credentials & Config
  storeId       String? // Tenant's Store ID on platform
  apiKey        String? @db.Text
  webhookSecret String? @db.Text

  menuSyncEnabled Boolean   @default(false)
  lastSyncAt      DateTime?
  commissionRate  Decimal?  @db.Decimal(5, 2)
  isActive        Boolean   @default(false)

  // Safety Lock matches Platform logic, but scoped to tenant
  defaultMarkup      Decimal? @db.Decimal(5, 2)
  useFallbackPricing Boolean  @default(false)

  // Margin Consent (Safety Lock)
  marginConsentAcceptedAt DateTime?
  marginConsentAcceptedBy Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, deliveryPlatformId]) // One config per platform per tenant
  @@index([tenantId])
}

model DeliveryDriver {
  id             Int         @id @default(autoincrement())
  tenantId       Int
  tenant         Tenant      @relation(fields: [tenantId], references: [id])
  name           String
  phone          String
  email          String?
  vehicleType    VehicleType @default(MOTORCYCLE)
  licensePlate   String?
  isActive       Boolean     @default(true)
  isAvailable    Boolean     @default(true)
  currentOrderId Int?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  orders         Order[]     @relation("DeliveryDriverOrders")

  @@unique([tenantId, phone])
  @@index([tenantId])
}

enum VehicleType {
  MOTORCYCLE
  BICYCLE
  CAR
  WALKING
}

// ============================================================================
// MULTI-CHANNEL PRICING
// Permite definir precios diferentes por producto y plataforma de delivery.
// Ejemplo: Pizza = $500 en local, $650 en Rappi, $600 en Glovo.
// ============================================================================

model ProductChannelPrice {
  id                 Int              @id @default(autoincrement())
  tenantId           Int
  tenant             Tenant           @relation(fields: [tenantId], references: [id])
  productId          Int
  product            Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  deliveryPlatformId Int
  deliveryPlatform   DeliveryPlatform @relation(fields: [deliveryPlatformId], references: [id], onDelete: Cascade)
  price              Decimal          @db.Decimal(10, 2) // Precio específico para este canal
  externalSku        String?          @db.VarChar(100) // SKU/PLU en la plataforma externa
  isAvailable        Boolean          @default(true) // Disponibilidad en este canal
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@unique([productId, deliveryPlatformId]) // Un precio por producto por plataforma
  @@index([tenantId])
  @@index([deliveryPlatformId])
  @@index([productId])
}
