generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model TenantConfig {
  id                 Int        @id @default(1)
  businessName       String
  enableStock        Boolean    @default(true)
  enableDelivery     Boolean    @default(true)
  enableKDS          Boolean    @default(false)
  enableFiscal       Boolean    @default(false)
  enableDigital      Boolean    @default(false)
  enableBlindCount   Boolean    @default(false) // Arqueo ciego: oculta monto esperado al cerrar turno
  currencySymbol     String     @default("$")
  // QR Menu Configuration
  qrMenuEnabled      Boolean    @default(false)
  qrMenuMode         QrMenuMode @default(INTERACTIVE)
  qrSelfOrderEnabled Boolean    @default(false) // Permitir pedidos desde celular
  qrMenuPdfUrl       String? // URL del PDF si mode=STATIC
  qrMenuBannerUrl    String? // Banner opcional para menú
  qrMenuTheme        Json? // Colores, tipografía personalizada
}

// FIX P1-001: Date-based sharding to eliminate single-row bottleneck
// Each business day gets its own sequence row, preventing deadlocks
// under high concurrency (>10 concurrent order requests)
model OrderSequence {
  id           Int      @id @default(autoincrement())
  sequenceKey  String?  @unique @db.VarChar(8) // Format: "YYYYMMDD" (e.g., "20260119")
  currentValue Int      @default(0)
  lastNumber   Int      @default(0) // Legacy field for backward compatibility
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([sequenceKey])
}

model Role {
  id          Int    @id @default(autoincrement())
  name        String @unique
  permissions Json
  users       User[]
}

model User {
  id                  Int         @id @default(autoincrement())
  roleId              Int
  role                Role        @relation(fields: [roleId], references: [id])
  name                String
  email               String?     @unique
  pinCode             String?     @unique @db.VarChar(6)
  passwordHash        String?
  uiSettings          Json?
  orders              Order[]     @relation("OrderServer")
  deliveries          Order[]     @relation("OrderDriver")
  shifts              CashShift[]
  isActive            Boolean     @default(true)
  failedLoginAttempts Int         @default(0) // Count of consecutive failed PIN attempts
  lockedUntil         DateTime? // Account locked until this time (null = not locked)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([roleId])
}

model Category {
  id               Int                   @id @default(autoincrement())
  name             String
  printerId        Int?
  printer          Printer?              @relation(fields: [printerId], references: [id])
  products         Product[]
  printerOverrides AreaPrinterOverride[] // Areas that override this category's printer
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  @@index([printerId])
}

model Printer {
  id             Int                   @id @default(autoincrement())
  name           String
  connectionType PrinterConnection     @default(NETWORK)
  ipAddress      String? // For NETWORK type: IP address (port 9100 default)
  windowsName    String? // For USB type: Windows printer name
  categories     Category[]
  areaOverrides  AreaPrinterOverride[] // Areas using this printer as override
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
}

enum PrinterConnection {
  NETWORK // TCP/IP connection (tcp://IP:9100)
  USB // Windows USB printer via printer name
}

model Product {
  id            Int                    @id @default(autoincrement())
  categoryId    Int
  category      Category               @relation(fields: [categoryId], references: [id])
  name          String
  description   String?
  price         Decimal                @db.Decimal(10, 2)
  image         String?
  productType   ProductType            @default(SIMPLE)
  isStockable   Boolean                @default(true)
  ingredients   ProductIngredient[]
  modifiers     ProductModifierGroup[]
  isActive      Boolean                @default(true)
  orderItems    OrderItem[]
  channelPrices ProductChannelPrice[] // Precios específicos por plataforma de delivery
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  @@index([categoryId])
}

enum ProductType {
  SIMPLE
  COMBO
  RECIPE
}

model ModifierGroup {
  id           Int                    @id @default(autoincrement())
  name         String
  minSelection Int                    @default(0)
  maxSelection Int                    @default(1)
  options      ModifierOption[]
  products     ProductModifierGroup[]
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
}

model ProductModifierGroup {
  productId       Int
  modifierGroupId Int
  product         Product       @relation(fields: [productId], references: [id])
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id])

  @@id([productId, modifierGroupId])
  @@index([modifierGroupId])
  @@index([productId])
}

model ModifierOption {
  id              Int                 @id @default(autoincrement())
  modifierGroupId Int
  group           ModifierGroup       @relation(fields: [modifierGroupId], references: [id])
  name            String
  priceOverlay    Decimal             @default(0) @db.Decimal(10, 2)
  isActive        Boolean             @default(true)
  ingredientId    Int?
  ingredient      Ingredient?         @relation(fields: [ingredientId], references: [id])
  qtyUsed         Decimal?            @default(1)
  orderModifiers  OrderItemModifier[]

  @@index([modifierGroupId])
  @@index([ingredientId])
}

model Ingredient {
  id                 Int                 @id @default(autoincrement())
  name               String
  unit               String
  cost               Decimal             @db.Decimal(10, 4)
  stock              Decimal             @db.Decimal(10, 4)
  minStock           Decimal             @default(0)
  products           ProductIngredient[]
  modifiers          ModifierOption[]
  movements          StockMovement[]
  purchaseOrderItems PurchaseOrderItem[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
}

model ProductIngredient {
  productId    Int
  ingredientId Int
  quantity     Decimal    @db.Decimal(10, 4)
  product      Product    @relation(fields: [productId], references: [id])
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  @@id([productId, ingredientId])
  @@index([ingredientId])
  @@index([productId])
}

model StockMovement {
  id           Int           @id @default(autoincrement())
  ingredientId Int
  ingredient   Ingredient    @relation(fields: [ingredientId], references: [id])
  type         StockMoveType
  quantity     Decimal       @db.Decimal(10, 4)
  reason       String? // Reason for movement (e.g. "Order #123", "Expired")
  createdAt    DateTime      @default(now())

  @@index([ingredientId])
}

enum StockMoveType {
  PURCHASE
  SALE
  WASTE
  ADJUSTMENT
}

model Supplier {
  id             Int             @id @default(autoincrement())
  name           String
  phone          String?
  email          String?
  address        String?
  taxId          String? // CUIT/RUT
  purchaseOrders PurchaseOrder[]
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([name])
}

model PurchaseOrder {
  id          Int                 @id @default(autoincrement())
  orderNumber Int                 @unique
  supplierId  Int
  supplier    Supplier            @relation(fields: [supplierId], references: [id])
  status      PurchaseStatus      @default(PENDING)
  subtotal    Decimal             @default(0) @db.Decimal(10, 2)
  total       Decimal             @default(0) @db.Decimal(10, 2)
  notes       String?             @db.Text
  orderedAt   DateTime            @default(now())
  receivedAt  DateTime?
  items       PurchaseOrderItem[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([supplierId])
  @@index([status])
  @@index([orderedAt])
}

model PurchaseOrderItem {
  id              Int           @id @default(autoincrement())
  purchaseOrderId Int
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  ingredientId    Int
  ingredient      Ingredient    @relation(fields: [ingredientId], references: [id])
  quantity        Decimal       @db.Decimal(10, 4)
  unitCost        Decimal       @db.Decimal(10, 4)

  @@index([purchaseOrderId])
  @@index([ingredientId])
}

enum PurchaseStatus {
  PENDING
  ORDERED
  PARTIAL
  RECEIVED
  CANCELLED
}

// ==================== INVOICING ====================

model Invoice {
  id            Int         @id @default(autoincrement())
  orderId       Int         @unique
  order         Order       @relation(fields: [orderId], references: [id])
  invoiceNumber String      @unique
  type          InvoiceType @default(RECEIPT)
  clientName    String?
  clientTaxId   String? // CUIT/DNI
  subtotal      Decimal     @db.Decimal(10, 2)
  tax           Decimal     @default(0) @db.Decimal(10, 2)
  total         Decimal     @db.Decimal(10, 2)
  createdAt     DateTime    @default(now())
}

enum InvoiceType {
  RECEIPT // Ticket simple
  INVOICE_B // Factura B (Consumidor Final)
}

model Order {
  id                  Int               @id @default(autoincrement())
  orderNumber         Int               @unique
  channel             OrderChannel      @default(POS)
  externalId          String?
  externalPayload     Json? // Payload raw del webhook para debugging/auditoría
  peopleCount         Int               @default(1)
  status              OrderStatus       @default(OPEN)
  paymentStatus       PaymentStatus     @default(PENDING)
  subtotal            Decimal           @default(0) @db.Decimal(10, 2)
  discount            Decimal           @default(0) @db.Decimal(10, 2)
  tip                 Decimal           @default(0) @db.Decimal(10, 2) // Total tips for this order
  total               Decimal           @default(0) @db.Decimal(10, 2)
  tableId             Int?
  table               Table?            @relation(fields: [tableId], references: [id])
  clientId            Int?
  client              Client?           @relation(fields: [clientId], references: [id])
  serverId            Int?
  server              User?             @relation("OrderServer", fields: [serverId], references: [id])
  driverId            Int?
  driver              User?             @relation("OrderDriver", fields: [driverId], references: [id])
  deliveryAddress     String? // Dirección específica de esta entrega
  deliveryNotes       String? // Notas de entrega ("Tocar timbre 2B")
  // Delivery Integration fields
  fulfillmentType     FulfillmentType   @default(DINE_IN)
  deliveryPlatformId  Int? // Plataforma externa (Rappi, PedidosYa, etc.)
  deliveryPlatform    DeliveryPlatform? @relation("PlatformOrders", fields: [deliveryPlatformId], references: [id])
  deliveryDriverId    Int? // Driver de flota propia
  deliveryDriver      DeliveryDriver?   @relation("DeliveryDriverOrders", fields: [deliveryDriverId], references: [id])
  estimatedDeliveryAt DateTime? // Hora estimada de entrega
  deliveryFee         Decimal?          @db.Decimal(10, 2) // Costo de envío
  platformCommission  Decimal?          @db.Decimal(10, 2) // Comisión pagada a plataforma
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  closedAt            DateTime?
  businessDate        DateTime          @db.Date // Para agrupar ventas por "Día Operativo"
  items               OrderItem[]
  payments            Payment[]
  invoice             Invoice?

  @@index([tableId])
  @@index([clientId])
  @@index([serverId])
  @@index([driverId])
  @@index([deliveryPlatformId])
  @@index([deliveryDriverId])
  @@index([businessDate])
  @@index([createdAt])
  @@index([externalId]) // Para búsquedas rápidas por ID externo (Rappi, Glovo)
}

enum OrderChannel {
  POS
  WAITER_APP
  QR_MENU
  DELIVERY_APP
}

enum OrderStatus {
  OPEN
  CONFIRMED
  IN_PREPARATION
  PREPARED
  ON_ROUTE
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

model OrderItem {
  id        Int                 @id @default(autoincrement())
  orderId   Int
  order     Order               @relation(fields: [orderId], references: [id])
  productId Int
  product   Product             @relation(fields: [productId], references: [id])
  quantity  Int
  unitPrice Decimal             @db.Decimal(10, 2)
  modifiers OrderItemModifier[]
  status    ItemStatus          @default(PENDING)
  notes     String?

  @@index([orderId])
  @@index([productId])
}

enum ItemStatus {
  PENDING
  COOKING
  READY
  SERVED
}

model OrderItemModifier {
  id               Int            @id @default(autoincrement())
  orderItemId      Int
  orderItem        OrderItem      @relation(fields: [orderItemId], references: [id])
  modifierOptionId Int
  modifierOption   ModifierOption @relation(fields: [modifierOptionId], references: [id])
  priceCharged     Decimal        @db.Decimal(10, 2)

  @@index([orderItemId])
  @@index([modifierOptionId])
}

model Area {
  id               Int                   @id @default(autoincrement())
  name             String
  tables           Table[]
  printerOverrides AreaPrinterOverride[] // Override print routing for this area
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
}

// Print Routing Override per Area (Toast-style)
// Allows an area to override the default category->printer routing
// Example: "Terraza" area sends all drinks to "Printer Terraza" instead of "Bar Printer"
model AreaPrinterOverride {
  id         Int       @id @default(autoincrement())
  areaId     Int
  area       Area      @relation(fields: [areaId], references: [id], onDelete: Cascade)
  categoryId Int? // If null, applies to ALL categories (area-wide override)
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  printerId  Int
  printer    Printer   @relation(fields: [printerId], references: [id])
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([areaId, categoryId]) // One override per category per area
  @@index([areaId])
  @@index([categoryId])
  @@index([printerId])
}

model Table {
  id             Int         @id @default(autoincrement())
  areaId         Int
  area           Area        @relation(fields: [areaId], references: [id])
  name           String
  x              Int?
  y              Int?
  status         TableStatus @default(FREE)
  currentOrderId Int?
  orders         Order[]
  qrCodes        QrCode[] // QR codes asociados a esta mesa
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([areaId])
}

enum TableStatus {
  FREE
  OCCUPIED
  RESERVED
  CLEANING
}

model Client {
  id            Int      @id @default(autoincrement())
  name          String
  phone         String?  @unique
  email         String?
  address       String?
  taxId         String?
  points        Int      @default(0)
  walletBalance Decimal  @default(0) @db.Decimal(10, 2)
  orders        Order[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model CashShift {
  id           Int       @id @default(autoincrement())
  userId       Int
  user         User      @relation(fields: [userId], references: [id])
  startTime    DateTime  @default(now())
  endTime      DateTime?
  startAmount  Decimal   @db.Decimal(10, 2)
  endAmount    Decimal?  @db.Decimal(10, 2)
  businessDate DateTime  @db.Date // Día operativo del turno
  payments     Payment[]

  @@index([userId])
  @@index([businessDate])
}

model Payment {
  id          Int           @id @default(autoincrement())
  orderId     Int
  order       Order         @relation(fields: [orderId], references: [id])
  shiftId     Int?
  shift       CashShift?    @relation(fields: [shiftId], references: [id])
  amount      Decimal       @db.Decimal(10, 2)
  tip         Decimal       @default(0) @db.Decimal(10, 2) // Tip included in this payment
  method      PaymentMethod
  externalRef String?
  createdAt   DateTime      @default(now())

  @@index([orderId])
  @@index([shiftId])
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  QR_INTEGRATED
  ONLINE
}

// Dynamic payment method configuration
model PaymentMethodConfig {
  id        Int      @id @default(autoincrement())
  code      String   @unique // Matches PaymentMethod enum value
  name      String // Display name: "Efectivo", "Tarjeta", etc.
  icon      String? // Lucide icon name
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Audit log for tracking critical actions
model AuditLog {
  id        Int         @id @default(autoincrement())
  userId    Int?
  action    AuditAction
  entity    String // Table/model name: 'Order', 'Payment', 'CashShift'
  entityId  Int?
  details   Json? // Additional context (old/new values, etc)
  ipAddress String?
  userAgent String?
  createdAt DateTime    @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([action])
  @@index([createdAt])
}

enum AuditAction {
  // Auth
  LOGIN
  LOGOUT
  LOGIN_FAILED
  // Orders
  ORDER_CREATED
  ORDER_CANCELLED
  ORDER_REFUNDED
  // Order Items
  ITEM_VOIDED // Item removed from order with reason
  ITEM_TRANSFERRED // Item moved to different table
  // Payments
  PAYMENT_RECEIVED
  PAYMENT_VOIDED
  // Pricing
  DISCOUNT_APPLIED // Manual discount with authorization
  // Cash
  SHIFT_OPENED
  SHIFT_CLOSED
  CASH_ADJUSTMENT
  // Inventory
  STOCK_ADJUSTED
  STOCK_WASTED
  BULK_PRICE_UPDATE // Mass price update operation
  // Admin
  USER_CREATED
  USER_DELETED
  ROLE_CHANGED
  CONFIG_CHANGED
}

// ============================================================================
// QR MENU
// ============================================================================

enum QrMenuMode {
  INTERACTIVE // Menú dinámico desde DB
  STATIC // PDF o imagen subida
}

model QrCode {
  id            Int       @id @default(autoincrement())
  code          String    @unique @db.VarChar(12) // UUID corto para URL
  tableId       Int? // null = QR genérico (no asociado a mesa)
  table         Table?    @relation(fields: [tableId], references: [id])
  isActive      Boolean   @default(true)
  scansCount    Int       @default(0)
  lastScannedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tableId])
}

// ============================================================================
// DELIVERY INTEGRATION
// ============================================================================

enum FulfillmentType {
  DINE_IN // Mesa en local
  TAKEAWAY // Para llevar (retira cliente)
  PLATFORM_DELIVERY // Delivery por plataforma externa (Rappi envía)
  SELF_DELIVERY // Delivery con flota propia del local
}

model DeliveryPlatform {
  id                      Int                   @id @default(autoincrement())
  code                    String                @unique // PEDIDOSYA, RAPPI, GLOVO, etc.
  name                    String
  isEnabled               Boolean               @default(false)
  apiKey                  String?               @db.VarChar(500) // Encrypted API key
  webhookSecret           String?               @db.VarChar(500) // Para validar webhooks entrantes
  storeId                 String? // ID del local en la plataforma
  menuSyncEnabled         Boolean               @default(false) // Sincronizar menú automáticamente
  lastSyncAt              DateTime?
  commissionRate          Decimal?              @db.Decimal(5, 2) // Porcentaje de comisión (ej: 15.00)
  // ============ SAFETY LOCK (Margin Warning Protocol) ============
  // Campos para el protocolo de consentimiento de margen.
  // El usuario DEBE aceptar el riesgo de usar precios base antes de activar.
  defaultMarkup           Decimal?              @db.Decimal(5, 2) // Markup automático sugerido (ej: 25.00 = +25%)
  marginConsentAcceptedAt DateTime? // Timestamp cuando el usuario aceptó el riesgo
  marginConsentAcceptedBy Int? // ID del usuario que aceptó
  useFallbackPricing      Boolean               @default(false) // Si true, usa precio base + markup cuando no hay precio específico
  // ================================================================
  config                  Json? // Configuración adicional específica
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  orders                  Order[]               @relation("PlatformOrders")
  productPrices           ProductChannelPrice[] // Precios específicos por producto
}

model DeliveryDriver {
  id             Int         @id @default(autoincrement())
  name           String
  phone          String
  email          String?
  vehicleType    VehicleType @default(MOTORCYCLE)
  licensePlate   String?
  isActive       Boolean     @default(true)
  isAvailable    Boolean     @default(true)
  currentOrderId Int?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  orders         Order[]     @relation("DeliveryDriverOrders")
}

enum VehicleType {
  MOTORCYCLE
  BICYCLE
  CAR
  WALKING
}

// ============================================================================
// MULTI-CHANNEL PRICING
// Permite definir precios diferentes por producto y plataforma de delivery.
// Ejemplo: Pizza = $500 en local, $650 en Rappi, $600 en Glovo.
// ============================================================================

model ProductChannelPrice {
  id                 Int              @id @default(autoincrement())
  productId          Int
  product            Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  deliveryPlatformId Int
  deliveryPlatform   DeliveryPlatform @relation(fields: [deliveryPlatformId], references: [id], onDelete: Cascade)
  price              Decimal          @db.Decimal(10, 2) // Precio específico para este canal
  externalSku        String?          @db.VarChar(100) // SKU/PLU en la plataforma externa
  isAvailable        Boolean          @default(true) // Disponibilidad en este canal
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@unique([productId, deliveryPlatformId]) // Un precio por producto por plataforma
  @@index([deliveryPlatformId])
  @@index([productId])
}
