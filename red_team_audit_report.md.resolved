# üî¥ RED TEAM SECURITY AUDIT REPORT
## PentiumPOS / Control Gastron√≥mico V2
### Auditor: CLAUDE OPUS 4.5 | Date: 2026-01-19 | Mode: HOSTILE

---

## EXECUTIVE SUMMARY

| Metric | Value |
|--------|-------|
| **Critical Issues** | 3 |
| **High Issues** | 6 |
| **Warnings** | 8 |
| **Overall Security Posture** | ‚ö†Ô∏è **PRODUCTION-READY WITH CAVEATS** |

The codebase demonstrates **enterprise-grade security patterns** in core areas (auth, HMAC, async handling), but contains several **architectural debt items** and **potential failure modes under load** that must be addressed before scaling.

---

## üö® CRITICAL FINDINGS

### CRIT-01: Sensitive Data Exposure in User API Response
**Severity:** CRITICAL | **Location:** [user.controller.ts#L156](file:///d:/Proyectos/control_gastronomicoV2/backend/src/controllers/user.controller.ts#L150-L170)

```typescript
// VIOLATION: API Rule #2 - No sensitive data in responses
const user = await prisma.user.findUnique({
    where: { id },
    select: {
        // ...
        pinCode: true,  // üî¥ EXPOSED: Raw PIN code in API response
        // ...
    }
});
```

**Impact:** PIN codes are authentication credentials. Exposing them in GET `/users/:id` allows:
- Account takeover via credential harvesting
- Privilege escalation if attacker compromises lower-privileged account

**Fix Required:**
```diff
select: {
    id: true,
    name: true,
    email: true,
-   pinCode: true,
    isActive: true,
```

---

### CRIT-02: HMAC Bypass Path in Dynamic Webhook Handler
**Severity:** CRITICAL | **Location:** [hmac.middleware.ts#L179-L200](file:///d:/Proyectos/control_gastronomicoV2/backend/src/integrations/delivery/webhooks/hmac.middleware.ts#L179-L205)

```typescript
// VIOLATION: SEC Rule #4 - All webhooks MUST verify HMAC
export function skipHmacInDevelopment(req, res, next) {
  if (process.env.NODE_ENV === 'development' && 
      process.env.SKIP_HMAC_VALIDATION === 'true') {
    // HMAC bypassed!
    req.parsedBody = JSON.parse(req.body.toString('utf-8'));
    return next();
  }
```

**Attack Vector:**
1. If `NODE_ENV=development` leaks to production (misconfigured Docker, Railway, etc.)
2. Attacker sets `SKIP_HMAC_VALIDATION=true` via env injection OR
3. Internal misconfiguration leaves both flags set

**Impact:** Attackers can inject FAKE delivery orders into the system:
- Financial fraud (orders never paid)
- Kitchen chaos (ghost orders)
- Reputation damage with delivery platforms

**Fix Required:**
```typescript
// NEVER allow bypass in ANY build. Remove this function entirely.
// If needed for testing, use proper mock adapters instead.
```

---

### CRIT-03: Order Discount Race Condition
**Severity:** CRITICAL | **Location:** [discount.service.ts#L86-L137](file:///d:/Proyectos/control_gastronomicoV2/backend/src/services/discount.service.ts#L86-L137)

The discount application transaction does NOT lock the order row:

```typescript
const result = await prisma.$transaction(async (tx) => {
    const order = await tx.order.findUnique({  // üî¥ READ WITHOUT LOCK
        where: { id: input.orderId }
    });
    // ... calculate discount ...
    await tx.order.update({...});  // üî¥ RACE: Another tx could have modified
});
```

**Attack Scenario:**
1. Manager A applies 10% discount (reads order.total = $100)
2. Manager B applies 20% discount (reads order.total = $100)
3. Both calculate on same base ‚Üí Total discount = 30% instead of 28%
4. Repeat attack ‚Üí Free orders

**Fix Required:**
```typescript
const order = await tx.order.findUnique({
    where: { id: input.orderId },
    // MYSQL: Use FOR UPDATE equivalent
}).$extends({
    query: {
        order: {
            findUnique: ({ args, query }) => 
                tx.$queryRawUnsafe(`SELECT * FROM Order WHERE id = ${args.where.id} FOR UPDATE`)
        }
    }
});
```

---

## üî∂ HIGH SEVERITY FINDINGS

### HIGH-01: JWT Tokens Lack Refresh Mechanism
**Impact:** 12h token expiry forces re-authentication during service, disrupting operations.

**Location:** [auth.service.ts#L140](file:///d:/Proyectos/control_gastronomicoV2/backend/src/services/auth.service.ts#L140)

```typescript
return jwt.sign(payload, JWT_SECRET!, { expiresIn: '12h' });
```

**Recommendation:** Implement refresh token rotation or extend to 24h with activity-based renewal.

---

### HIGH-02: No Database Connection Pooling Configuration
**Impact:** Under load, Prisma will exhaust database connections.

**Location:** [prisma.ts](file:///d:/Proyectos/control_gastronomicoV2/backend/src/lib/prisma.ts)

```typescript
export const prisma = globalForPrisma.prisma || new PrismaClient();
// üî¥ No pool configuration - uses Prisma defaults (10 connections)
```

**Fix Required:**
```typescript
new PrismaClient({
    datasources: {
        db: {
            url: process.env.DATABASE_URL + '?connection_limit=100&pool_timeout=20'
        }
    }
});
```

---

### HIGH-03: Redis Connection Not Using TLS
**Impact:** Credentials transmitted in plaintext over network.

**Location:** [BullMQService.ts#L28-L32](file:///d:/Proyectos/control_gastronomicoV2/backend/src/lib/queue/BullMQService.ts#L28-L32)

```typescript
const REDIS_CONFIG = {
  host: process.env.REDIS_HOST || 'localhost',
  port: parseInt(process.env.REDIS_PORT || '6379', 10),
  // üî¥ No TLS, no password config
};
```

---

### HIGH-04: Unvalidated [platform](file:///d:/Proyectos/control_gastronomicoV2/backend/src/integrations/delivery/adapters/RappiAdapter.ts#157-160) Parameter Type Before Processing
**Impact:** Runtime crash if non-string passed.

**Location:** [webhook.controller.ts#L53](file:///d:/Proyectos/control_gastronomicoV2/backend/src/integrations/delivery/webhooks/webhook.controller.ts#L53)

```typescript
const platformCode = String(req.params.platform || '').toUpperCase();
// Defensive, but better to validate explicitly with Zod
```

---

### HIGH-05: Raw SQL Fallback Without Parameterization
**Impact:** Potential SQL injection if error handling path is triggered.

**Location:** [orderNumber.service.ts#L66-L69](file:///d:/Proyectos/control_gastronomicoV2/backend/src/services/orderNumber.service.ts#L66-L69)

```typescript
const result = await tx.$executeRaw`
    INSERT INTO OrderSequence (id, lastNumber) VALUES (1, 1)
    ON DUPLICATE KEY UPDATE lastNumber = lastNumber + 1
`;
```

> [!NOTE]
> This is technically safe (template literal with `$executeRaw`), but the pattern is risky. DB Rule #1 states raw SQL must be justified - add comment explaining why.

---

### HIGH-06: Table Close Does Not Validate All Orders on Table
**Impact:** If multiple orders exist on one table, closing one leaves table in incorrect state.

**Location:** [table.service.ts#L227-L333](file:///d:/Proyectos/control_gastronomicoV2/backend/src/services/table.service.ts#L227-L333)

The [closeTableWithPayment](file:///d:/Proyectos/control_gastronomicoV2/backend/src/services/table.service.ts#224-334) only checks `table.currentOrderId`, not all pending orders associated with that table.

---

## ‚ö†Ô∏è WARNINGS

### WARN-01: No Global Rate Limiting on API
Only auth endpoints have rate limiting. High-volume endpoints (`/orders`, `/analytics`) are unprotected.

**Location:** [app.ts](file:///d:/Proyectos/control_gastronomicoV2/backend/src/app.ts)

---

### WARN-02: CORS Wildcard Warning Insufficient
Production should FAIL startup, not just warn, if CORS_ORIGINS is missing.

---

### WARN-03: Dynamic Import Inside Transaction
**Location:** [table.service.ts#L192](file:///d:/Proyectos/control_gastronomicoV2/backend/src/services/table.service.ts#L192)

```typescript
const { orderNumberService } = await import('./orderNumber.service');
```

Dynamic imports inside Prisma transactions add latency and potential deadlock risk.

---

### WARN-04: `@ts-expect-error` Suppressions
**Locations:** 
- [hmac.middleware.ts#L115](file:///d:/Proyectos/control_gastronomicoV2/backend/src/integrations/delivery/webhooks/hmac.middleware.ts#L115)
- [hmac.middleware.ts#L192](file:///d:/Proyectos/control_gastronomicoV2/backend/src/integrations/delivery/webhooks/hmac.middleware.ts#L192)

Type safety bypasses indicate incomplete Express type declarations. Fix with proper declaration merging.

---

### WARN-05: Audit Log Not Within Same Transaction
**Location:** [discount.service.ts#L140](file:///d:/Proyectos/control_gastronomicoV2/backend/src/services/discount.service.ts#L140)

Audit logging happens AFTER the transaction commits. If audit fails, there's no record of the discount.

---

### WARN-06: Missing Index on Order.externalId Queries
Performance bottleneck for delivery order lookups.

---

### WARN-07: Console.warn Used Instead of Logger
**Location:** [order.service.ts#L122](file:///d:/Proyectos/control_gastronomicoV2/backend/src/services/order.service.ts#L122)

Should use structured logger for production observability.

---

### WARN-08: Webhook Error Still Returns 200 OK
**Location:** [webhook.controller.ts#L118-L124](file:///d:/Proyectos/control_gastronomicoV2/backend/src/integrations/delivery/webhooks/webhook.controller.ts#L118-L124)

```typescript
// A√∫n respondemos 200 para evitar reintentos de la plataforma
return res.status(200).json({
    success: false, // üî¥ Misleading: 200 with success: false
```

This is intentional but should be documented in runbook.

---

## ‚úÖ AREAS OF EXCELLENCE

| Area | Assessment |
|------|------------|
| **HMAC Implementation** | Proper timing-safe comparison, per-platform secrets |
| **Async Handling** | All controllers wrapped with [asyncHandler](file:///d:/Proyectos/control_gastronomicoV2/backend/src/middleware/asyncHandler.ts#3-12) |
| **Account Lockout** | 5 attempts, 15-minute lockout, per-user tracking |
| **JWT Validation** | Secret entropy check at startup (32+ chars) |
| **Transaction Isolation** | Critical operations use `$transaction` |
| **Queue Retry Policy** | 10 retries with exponential backoff (enterprise-grade) |
| **Audit Logging** | Comprehensive action types, IP/UserAgent captured |

---

## COMPLIANCE CHECKLIST

| Rule | Status | Notes |
|------|--------|-------|
| DB: Prisma is source of truth | ‚úÖ PASS | Raw SQL justified in orderNumber fallback |
| API: No sensitive data in responses | ‚ùå FAIL | PIN exposed in user.controller |
| ASYNC: No unhandled promise rejections | ‚úÖ PASS | asyncHandler pattern applied |
| SEC: All webhooks verify HMAC | ‚ö†Ô∏è CONDITIONAL | Bypass exists for dev mode |

---

## REMEDIATION PRIORITY

| Priority | Issue | Effort | Business Impact |
|----------|-------|--------|-----------------|
| P0 (24h) | CRIT-01: PIN Exposure | 5 min | Credential theft |
| P0 (24h) | CRIT-02: HMAC Bypass | 10 min | Fake order injection |
| P0 (48h) | CRIT-03: Discount Race | 2 hr | Financial fraud |
| P1 (1 wk) | HIGH-02: DB Pooling | 30 min | Production crash |
| P1 (1 wk) | HIGH-03: Redis TLS | 1 hr | Credential sniffing |
| P2 (2 wk) | WARN-01: API Rate Limit | 2 hr | DDoS vulnerability |

---

## AUDITOR SIGNATURE

```
AUDIT COMPLETE: 2026-01-19T01:36:46-03:00
AUDITOR: CLAUDE OPUS 4.5 (Red Team Protocol)
VERDICT: CONDITIONAL PASS - Address P0 items before production traffic
```
